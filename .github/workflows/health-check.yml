name: Health Check Monitoring

on:
  schedule:
    # Run health checks daily at 8 AM UTC
    - cron: '0 8 * * *'
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: read
  issues: write

jobs:
  health-check:
    name: Check Production Health
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check backend health
        id: backend-health
        run: |
          if [ -z "${{ secrets.BACKEND_URL }}" ]; then
            echo "BACKEND_URL not configured, skipping backend health check"
            echo "backend_status=skipped" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "Checking backend health at ${{ secrets.BACKEND_URL }}/api/health"
          
          RESPONSE=$(curl -s -w "\n%{http_code}" "${{ secrets.BACKEND_URL }}/api/health" || echo "000")
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n-1)
          
          echo "HTTP Status: $HTTP_CODE"
          echo "Response: $BODY"
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "backend_status=healthy" >> $GITHUB_OUTPUT
            echo "Backend is healthy âœ“"
          else
            echo "backend_status=unhealthy" >> $GITHUB_OUTPUT
            echo "Backend health check failed with status $HTTP_CODE"
            exit 1
          fi
        continue-on-error: true

      - name: Check backend readiness
        id: backend-ready
        run: |
          if [ -z "${{ secrets.BACKEND_URL }}" ]; then
            echo "BACKEND_URL not configured, skipping readiness check"
            echo "ready_status=skipped" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "Checking backend readiness at ${{ secrets.BACKEND_URL }}/api/ready"
          
          RESPONSE=$(curl -s -w "\n%{http_code}" "${{ secrets.BACKEND_URL }}/api/ready" || echo "000")
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n-1)
          
          echo "HTTP Status: $HTTP_CODE"
          echo "Response: $BODY"
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "ready_status=ready" >> $GITHUB_OUTPUT
            echo "Backend is ready âœ“"
          else
            echo "ready_status=not_ready" >> $GITHUB_OUTPUT
            echo "Backend readiness check failed with status $HTTP_CODE"
            exit 1
          fi
        continue-on-error: true

      - name: Check frontend health
        id: frontend-health
        run: |
          if [ -z "${{ secrets.FRONTEND_URL }}" ]; then
            echo "FRONTEND_URL not configured, skipping frontend health check"
            echo "frontend_status=skipped" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "Checking frontend at ${{ secrets.FRONTEND_URL }}"
          
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "${{ secrets.FRONTEND_URL }}" || echo "000")
          
          echo "HTTP Status: $HTTP_CODE"
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "frontend_status=healthy" >> $GITHUB_OUTPUT
            echo "Frontend is healthy âœ“"
          else
            echo "frontend_status=unhealthy" >> $GITHUB_OUTPUT
            echo "Frontend health check failed with status $HTTP_CODE"
            exit 1
          fi
        continue-on-error: true

      - name: Check database connectivity
        id: db-check
        run: |
          if [ -z "${{ secrets.BACKEND_URL }}" ]; then
            echo "BACKEND_URL not configured, skipping database check"
            echo "db_status=skipped" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "Checking database status via backend health endpoint"
          
          DB_STATUS=$(curl -s "${{ secrets.BACKEND_URL }}/api/health" | grep -o '"connected":[^,}]*' | cut -d':' -f2 || echo "unknown")
          
          echo "Database status: $DB_STATUS"
          
          if [ "$DB_STATUS" = "true" ]; then
            echo "db_status=connected" >> $GITHUB_OUTPUT
            echo "Database is connected âœ“"
          else
            echo "db_status=disconnected" >> $GITHUB_OUTPUT
            echo "Database is not connected"
            exit 1
          fi
        continue-on-error: true

      - name: Send Slack notification on failure
        if: failure() && secrets.SLACK_WEBHOOK_URL != ''
        run: |
          curl -X POST "${{ secrets.SLACK_WEBHOOK_URL }}" \
            -H 'Content-Type: application/json' \
            -d '{
              "text": "ðŸš¨ Health Check Failed",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*GNB Transfer Health Check Failed*\n\nOne or more health checks have failed. Please investigate immediately."
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Backend:* ${{ steps.backend-health.outputs.backend_status }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Frontend:* ${{ steps.frontend-health.outputs.frontend_status }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Database:* ${{ steps.db-check.outputs.db_status }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Time:* '"$(date -u '+%Y-%m-%d %H:%M:%S UTC')"'"
                    }
                  ]
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Workflow"
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }
                  ]
                }
              ]
            }'

      - name: Create issue on repeated failures
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'ðŸš¨ Health Check Failure - ' + new Date().toISOString().split('T')[0];
            const body = `## Health Check Failed
            
            The automated health check has detected issues with the production deployment.
            
            **Details:**
            - Backend Status: ${{ steps.backend-health.outputs.backend_status }}
            - Frontend Status: ${{ steps.frontend-health.outputs.frontend_status }}
            - Database Status: ${{ steps.db-check.outputs.db_status }}
            - Time: ${new Date().toISOString()}
            - Workflow Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
            **Action Required:**
            Please investigate the issue immediately and refer to the RUNBOOK.md for troubleshooting steps.
            
            **Automated Health Check**
            This issue was created automatically by the health monitoring workflow.
            `;
            
            // Check if there's already an open issue for today
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'health-check-failure',
              per_page: 10
            });
            
            const today = new Date().toISOString().split('T')[0];
            const existingIssue = issues.data.find(issue => issue.title.includes(today));
            
            if (!existingIssue) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['health-check-failure', 'urgent', 'production']
              });
            }
