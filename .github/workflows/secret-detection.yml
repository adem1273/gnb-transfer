name: Secret Detection

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]

jobs:
  detect-secrets:
    name: Detect Secrets in Code
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for comprehensive scanning
      
      - name: Check for .env files in commit
        run: |
          echo "Checking for .env files in git..."
          if git ls-files | grep -E '\.env$|backend/\.env'; then
            echo "❌ ERROR: .env files found in repository!"
            echo "Files found:"
            git ls-files | grep -E '\.env$|backend/\.env'
            echo ""
            echo "⚠️  SECURITY VIOLATION: Environment files must not be committed!"
            echo "Please remove these files and follow the secret rotation guide:"
            echo "  1. git rm --cached <file>"
            echo "  2. Run: ./ops/rotate-secrets.sh"
            echo ""
            exit 1
          else
            echo "✓ No .env files found in repository"
          fi
      
      - name: Scan for exposed secrets in code
        run: |
          echo "Scanning for common secret patterns..."
          
          # Check for MongoDB URIs
          if git --no-pager grep -n -i "mongodb+srv://" -- '*.js' '*.mjs' '*.jsx' '*.ts' '*.tsx' '*.json' '*.yml' '*.yaml' || true; then
            echo "❌ ERROR: MongoDB connection string found in code!"
            echo "Use environment variables instead: process.env.MONGO_URI"
            exit 1
          fi
          
          # Check for JWT secrets (hardcoded)
          if git --no-pager grep -n -E "JWT_SECRET\s*=\s*['\"](?!process\.env)[^'\"]{10,}" -- '*.js' '*.mjs' '*.jsx' '*.ts' '*.tsx' || true; then
            echo "❌ ERROR: Hardcoded JWT_SECRET found!"
            echo "Use environment variables instead: process.env.JWT_SECRET"
            exit 1
          fi
          
          # Check for OpenAI API keys
          if git --no-pager grep -n -E "sk-[a-zA-Z0-9]{20,}" -- '*.js' '*.mjs' '*.jsx' '*.ts' '*.tsx' '*.json' || true; then
            echo "❌ ERROR: OpenAI API key found in code!"
            echo "Use environment variables instead: process.env.OPENAI_API_KEY"
            exit 1
          fi
          
          # Check for Stripe secret keys
          if git --no-pager grep -n -E "sk_live_[a-zA-Z0-9]{20,}" -- '*.js' '*.mjs' '*.jsx' '*.ts' '*.tsx' '*.json' || true; then
            echo "❌ ERROR: Stripe secret key found in code!"
            echo "Use environment variables instead: process.env.STRIPE_SECRET_KEY"
            exit 1
          fi
          
          # Check for generic API keys patterns
          if git --no-pager grep -n -iE "(api[_-]?key|apikey|api[_-]?secret)\s*[=:]\s*['\"][a-zA-Z0-9]{20,}['\"]" -- '*.js' '*.mjs' '*.jsx' '*.ts' '*.tsx' || true; then
            echo "❌ ERROR: Hardcoded API key found!"
            echo "Use environment variables for all secrets"
            exit 1
          fi
          
          echo "✓ No exposed secrets detected in code"
      
      - name: Check for sensitive data in recent commits
        if: github.event_name == 'pull_request'
        run: |
          echo "Checking recent commits for sensitive patterns..."
          
          # Check commits in this PR
          git --no-pager log origin/${{ github.base_ref }}..${{ github.head_ref }} --all --oneline
          
          # Check for MONGO_URI in commit messages or diffs
          if git --no-pager log --all --grep="MONGO_URI" origin/${{ github.base_ref }}..${{ github.head_ref }} | grep -q "MONGO_URI"; then
            echo "⚠️  WARNING: MONGO_URI mentioned in commit history"
            echo "This may indicate exposed credentials"
          fi
          
          # Check for JWT_SECRET in commit messages
          if git --no-pager log --all --grep="JWT_SECRET" origin/${{ github.base_ref }}..${{ github.head_ref }} | grep -q "JWT_SECRET"; then
            echo "⚠️  WARNING: JWT_SECRET mentioned in commit history"
            echo "Ensure no actual secret values were committed"
          fi
          
          echo "✓ Commit history check completed"
      
      - name: Verify .gitignore contains .env patterns
        run: |
          echo "Verifying .gitignore configuration..."
          
          if ! grep -q "backend/\.env" .gitignore; then
            echo "❌ ERROR: .gitignore missing 'backend/.env' entry"
            exit 1
          fi
          
          if ! grep -q "^\.env$" .gitignore; then
            echo "❌ ERROR: .gitignore missing '.env' entry"
            exit 1
          fi
          
          echo "✓ .gitignore properly configured"
      
      - name: Summary
        if: success()
        run: |
          echo ""
          echo "✅ Secret Detection Passed!"
          echo ""
          echo "All checks completed successfully:"
          echo "  ✓ No .env files in repository"
          echo "  ✓ No exposed secrets in code"
          echo "  ✓ .gitignore properly configured"
          echo ""
          echo "Remember: Never commit secrets!"
          echo "Use environment variables for all sensitive data."
