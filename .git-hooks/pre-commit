#!/bin/bash

# GNB Transfer Pre-Commit Hook
# This script runs before each commit to ensure code quality and security

set -e

echo "ðŸ” Running pre-commit checks..."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Track if any checks fail
FAILED=0

# Function to print colored output
print_error() {
    echo -e "${RED}âœ— $1${NC}"
}

print_success() {
    echo -e "${GREEN}âœ“ $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}âš  $1${NC}"
}

# 1. Check for secrets in staged files
echo ""
echo "1. Checking for secrets and sensitive data..."

# Patterns to check for
SECRET_PATTERNS=(
    "MONGO_URI=mongodb"
    "JWT_SECRET=[^y][^o][^u][^r]"  # Not the example value
    "STRIPE_SECRET_KEY=sk_live"
    "OPENAI_API_KEY=sk-[a-zA-Z0-9]"
    "password.*=.*[^example]"
    "api[_-]?key.*=.*[a-zA-Z0-9]{20,}"
    "secret.*=.*[a-zA-Z0-9]{20,}"
)

# Get staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

for file in $STAGED_FILES; do
    # Skip binary files and specific patterns
    if [[ $file == *.png ]] || [[ $file == *.jpg ]] || [[ $file == *.jpeg ]] || \
       [[ $file == *.gif ]] || [[ $file == *.ico ]] || [[ $file == *.pdf ]] || \
       [[ $file == *node_modules* ]] || [[ $file == *.lock ]]; then
        continue
    fi

    # Check if file exists (it might be deleted)
    if [ ! -f "$file" ]; then
        continue
    fi

    for pattern in "${SECRET_PATTERNS[@]}"; do
        if grep -qiE "$pattern" "$file"; then
            print_error "Potential secret found in $file"
            print_warning "Pattern: $pattern"
            FAILED=1
        fi
    done
done

if [ $FAILED -eq 0 ]; then
    print_success "No secrets detected"
fi

# 2. Check for .env files
echo ""
echo "2. Checking for .env files..."

if echo "$STAGED_FILES" | grep -q "\.env$\|\.env\.local$\|\.env\.production$"; then
    print_error ".env files should not be committed!"
    print_warning "Remove .env files from staging: git reset HEAD .env"
    FAILED=1
else
    print_success "No .env files in commit"
fi

# 3. Run ESLint on JavaScript/JSX files
echo ""
echo "3. Running ESLint..."

JS_FILES=$(echo "$STAGED_FILES" | grep -E '\.(js|jsx|mjs)$' || true)

if [ -n "$JS_FILES" ]; then
    # Check if in frontend or backend
    FRONTEND_JS=$(echo "$JS_FILES" | grep -v "^backend/" || true)
    BACKEND_JS=$(echo "$JS_FILES" | grep "^backend/" || true)

    if [ -n "$FRONTEND_JS" ]; then
        if [ -f "package.json" ]; then
            echo "Linting frontend files..."
            if npm run lint --silent 2>/dev/null; then
                print_success "Frontend linting passed"
            else
                print_warning "Frontend linting failed (non-blocking)"
                # Don't fail the commit for linting errors
            fi
        fi
    fi

    if [ -n "$BACKEND_JS" ]; then
        if [ -f "backend/package.json" ]; then
            echo "Linting backend files..."
            cd backend
            if npm run lint --silent 2>/dev/null; then
                print_success "Backend linting passed"
            else
                print_warning "Backend linting failed (non-blocking)"
                # Don't fail the commit for linting errors
            fi
            cd ..
        fi
    fi
else
    print_success "No JavaScript files to lint"
fi

# 4. Check for console.log in production code
echo ""
echo "4. Checking for console statements..."

CONSOLE_FOUND=0
for file in $STAGED_FILES; do
    if [[ $file == *.js ]] || [[ $file == *.jsx ]] || [[ $file == *.mjs ]]; then
        if [ -f "$file" ] && grep -n "console\.(log\|debug\|info)" "$file" | grep -v "// eslint-disable" > /dev/null; then
            print_warning "console statements found in $file"
            CONSOLE_FOUND=1
        fi
    fi
done

if [ $CONSOLE_FOUND -eq 0 ]; then
    print_success "No problematic console statements"
else
    print_warning "Consider removing console statements or disabling with eslint comments"
fi

# 5. Check for large files
echo ""
echo "5. Checking for large files..."

LARGE_FILE_LIMIT=5242880  # 5MB

for file in $STAGED_FILES; do
    if [ -f "$file" ]; then
        FILE_SIZE=$(wc -c < "$file")
        if [ $FILE_SIZE -gt $LARGE_FILE_LIMIT ]; then
            print_warning "Large file detected: $file ($(numfmt --to=iec-i --suffix=B $FILE_SIZE))"
            print_warning "Consider using Git LFS for large files"
        fi
    fi
done

print_success "File size check complete"

# 6. Check package.json changes
echo ""
echo "6. Checking package.json changes..."

if echo "$STAGED_FILES" | grep -q "package\.json$"; then
    print_warning "package.json has been modified"
    print_warning "Remember to run 'npm install' and commit package-lock.json if needed"
fi

# Final result
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
if [ $FAILED -eq 1 ]; then
    print_error "Pre-commit checks failed!"
    echo ""
    print_warning "Fix the issues above before committing"
    print_warning "To bypass this check (not recommended): git commit --no-verify"
    exit 1
else
    print_success "All pre-commit checks passed!"
    echo ""
fi

exit 0
